<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Halajobs.qa</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
    header { text-align: center; padding: 1rem; background: #007bff; color: #fff; position: sticky; top: 0; z-index: 100; }
    header h1 { margin: 0; font-size: 1.5rem; }
    .controls { display: flex; justify-content: center; gap: 10px; margin: 1rem; flex-wrap: wrap; }
    .controls input, .controls select { padding: 8px; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; }
    .btn { background: #28a745; color: #fff; padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: #218838; }
    #feed { max-width: 600px; margin: 1rem auto; padding: 0 10px; }
    .job-card { background: #fff; padding: 1rem; margin-bottom: 1rem; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .job-card h3 { margin: 0 0 5px; }
    .job-card small { color: #777; }
    footer { text-align: center; padding: 1rem; background: #eee; margin-top: 2rem; font-size: 0.9rem; }
    #postModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; }
    .modal-content input, .modal-content textarea, .modal-content select { width:100%; padding:8px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; }
    .close { float:right; cursor:pointer; font-size:20px; }
    #successTick { display:none; text-align:center; font-size:1.2rem; color:green; }
  </style>
</head>
<body>

  <header>
    <h1>Halajobs.qa</h1>
    <div class="controls">
      <input type="text" id="searchBar" placeholder="Search jobs...">
      <select id="categoryFilter">
        <option value="">All Categories</option>
        <option value="Helper">Helper</option>
        <option value="Driver">Driver</option>
        <option value="Delivery">Delivery</option>
        <option value="Accountant">Accountant</option>
        <option value="Engineering">Engineering</option>
        <option value="Others">Others</option>
      </select>
      <button class="btn" id="openPostModal">+ Post Job</button>
    </div>
  </header>

  <main id="feed">Loading jobs...</main>

  <footer>© 2025 Halajobs.qa — Your Gateway to Jobs in Qatar</footer>

  <!-- Post Job Modal -->
  <div id="postModal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h2>Post a Job</h2>
      <input type="text" id="position" placeholder="Position *" required>
      <textarea id="description" placeholder="Job Description *" required></textarea>
      <input type="text" id="salary" placeholder="Salary">
      <input type="text" id="company" placeholder="Company *" required>
      <select id="category" required>
        <option value="">Category *</option>
        <option value="Helper">Helper</option>
        <option value="Driver">Driver</option>
        <option value="Delivery">Delivery</option>
        <option value="Accountant">Accountant</option>
        <option value="Engineering">Engineering</option>
        <option value="Others">Others</option>
      </select>
      <input type="file" id="poster" accept="image/*">
      <button class="btn" id="postJob">Post Job</button>
      <div id="successTick">✅ Job Posted Successfully!</div>
    </div>
  </div>

  <script>
    // ✅ Your Supabase credentials
    const SUPABASE_URL = "https://ehoctsjvtfuesqeonlco.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVob2N0c2p2dGZ1ZXNxZW9ubGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTU2ODcsImV4cCI6MjA3MjU3MTY4N30.kGz2t58YXWTwOB_h40dH0GOBLF12FQxKsZnqQ983Xro";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const feed = document.getElementById("feed");
    const postModal = document.getElementById("postModal");
    const openPostModal = document.getElementById("openPostModal");
    const closeModal = document.getElementById("closeModal");
    const postJobBtn = document.getElementById("postJob");
    const successTick = document.getElementById("successTick");
    const searchBar = document.getElementById("searchBar");
    const categoryFilter = document.getElementById("categoryFilter");

    async function loadJobs() {
      feed.innerHTML = "Loading jobs...";
      let { data, error } = await supabase
        .from("jobs")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        feed.innerHTML = "Error loading jobs";
        return;
      }

      const now = new Date();
      data = data.filter(job => !job.expiry_timestamp || new Date(job.expiry_timestamp) > now);

      if (data.length === 0) {
        feed.innerHTML = "<p>No jobs available</p>";
        return;
      }

      displayJobs(data);
    }

    function displayJobs(jobs) {
      feed.innerHTML = "";
      jobs.forEach(job => {
        const card = document.createElement("div");
        card.className = "job-card";
        card.innerHTML = `
          <h3>${job.position} - ${job.company}</h3>
          <p>${job.description}</p>
          <small>Category: ${job.category}</small><br>
          <button onclick="shareJob('${job.position}', '${job.company}', '${job.description}')">🔗 Share</button>
        `;
        feed.appendChild(card);
      });
    }

    async function addJob() {
      const position = document.getElementById("position").value.trim();
      const description = document.getElementById("description").value.trim();
      const salary = document.getElementById("salary").value.trim();
      const company = document.getElementById("company").value.trim();
      const category = document.getElementById("category").value;

      if (!position || !description || !company || !category) {
        alert("Please fill in required fields.");
        return;
      }

      const expiry = new Date();
      expiry.setDate(expiry.getDate() + 14);

      const { error } = await supabase.from("jobs").insert([{
        position, description, salary, company, category,
        expiry_timestamp: expiry.toISOString()
      }]);

      if (error) {
        console.error(error);
        alert("Error posting job.");
        return;
      }

      successTick.style.display = "block";
      setTimeout(() => { successTick.style.display = "none"; }, 2000);

      document.getElementById("position").value = "";
      document.getElementById("description").value = "";
      document.getElementById("salary").value = "";
      document.getElementById("company").value = "";
      document.getElementById("category").value = "";
      document.getElementById("poster").value = "";

      postModal.style.display = "none";
      loadJobs();
    }

    function shareJob(position, company, description) {
      const text = `🔹 ${position} - ${company}\n📋 ${description}\n🌐 Find more jobs at: https://farisconnects.github.io/halajobs-qa/`;
      if (navigator.share) {
        navigator.share({ text });
      } else {
        navigator.clipboard.writeText(text);
        alert("Copied job details to clipboard!");
      }
    }

    searchBar.addEventListener("input", async () => {
      const keyword = searchBar.value.toLowerCase();
      let { data, error } = await supabase.from("jobs").select("*").order("created_at", { ascending: false });
      if (!error) {
        data = data.filter(job => job.position.toLowerCase().includes(keyword) || job.description.toLowerCase().includes(keyword));
        displayJobs(data);
      }
    });

    categoryFilter.addEventListener("change", async () => {
      const category = categoryFilter.value;
      let { data, error } = await supabase.from("jobs").select("*").order("created_at", { ascending: false });
      if (!error) {
        if (category) data = data.filter(job => job.category === category);
        displayJobs(data);
      }
    });

    openPostModal.onclick = () => postModal.style.display = "flex";
    closeModal.onclick = () => postModal.style.display = "none";
    postJobBtn.onclick = addJob;
    window.onload = loadJobs;
  </script>
</body>
</html>
