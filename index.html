<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Halajobs.qa — Your Gateway to Jobs in Qatar</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0;
      background: #f5f6fa;
      color: #333;
    }
    header {
      background: #0066cc;
      color: #fff;
      padding: 1rem;
      text-align: center;
      position: sticky; top: 0; z-index: 1000;
    }
    header h1 { margin: 0; font-size: 1.8rem; }
    .search-filter {
      margin-top: .5rem;
      display: flex; gap: .5rem; justify-content: center;
    }
    .search-filter input, .search-filter select {
      padding: .5rem; border-radius: .5rem; border: none;
      flex: 1; max-width: 200px;
    }
    .add-btn {
      margin-top: .5rem;
      background: #fff; color: #0066cc;
      padding: .5rem 1rem; border: none; border-radius: 1rem;
      cursor: pointer; font-weight: bold;
    }
    main { padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
    .card {
      background: #fff;
      padding: 1rem;
      border-radius: .75rem;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
    }
    .card h3 { margin: 0 0 .5rem 0; }
    .card small { color: #666; }
    .card img { max-width: 100%; margin-top: .5rem; border-radius: .5rem; }
    .share-btns { margin-top: .5rem; display: flex; gap: .5rem; }
    .share-btns button {
      flex: 1;
      padding: .4rem;
      border: none;
      border-radius: .5rem;
      cursor: pointer;
      background: #0066cc; color: #fff;
    }
    footer {
      text-align: center;
      padding: 1rem;
      background: #eee;
      margin-top: 2rem;
      font-size: .9rem;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,.5);
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 1.5rem;
      border-radius: 1rem;
      max-width: 400px; width: 100%;
    }
    .modal-content h2 { margin-top: 0; }
    .modal-content label { display: block; margin-top: .5rem; font-weight: bold; }
    .modal-content input, .modal-content textarea, .modal-content select {
      width: 100%;
      padding: .5rem; margin-top: .3rem;
      border: 1px solid #ccc; border-radius: .5rem;
    }
    .modal-content button {
      margin-top: 1rem; padding: .5rem;
      width: 100%;
      background: #0066cc; color: #fff;
      border: none; border-radius: .5rem;
      cursor: pointer; font-weight: bold;
    }
    .close-btn {
      float: right; cursor: pointer; font-size: 1.5rem; color: #666;
    }
    .success { display: none; color: green; margin-top: .5rem; font-weight: bold; }
  </style>
</head>
<body>
  <header>
    <h1>Halajobs.qa</h1>
    <div class="search-filter">
      <input type="text" id="searchInput" placeholder="Search jobs...">
      <select id="categoryFilter">
        <option value="">All Categories</option>
        <option value="Driver">Driver</option>
        <option value="IT">IT</option>
        <option value="Construction">Construction</option>
        <option value="Hospitality">Hospitality</option>
        <option value="Engineering">Engineering</option>
        <option value="Accountant">Accountant</option>
        <option value="Delivery">Delivery</option>
        <option value="Others">Others</option>
      </select>
    </div>
    <button class="add-btn" onclick="openModal()">+ Post Job</button>
  </header>

  <main>
    <div id="feed">Loading jobs...</div>
  </main>

  <footer>
    © 2025 Halajobs.qa — Your Gateway to Jobs in Qatar
  </footer>

  <!-- Modal -->
  <div class="modal" id="jobModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h2>Post a Job</h2>
      <form id="jobForm">
        <label>Position *</label>
        <input type="text" id="position" required>
        <label>Job Description *</label>
        <textarea id="description" required></textarea>
        <label>Salary</label>
        <input type="text" id="salary">
        <label>Company *</label>
        <input type="text" id="company" required>
        <label>Contact *</label>
        <input type="text" id="contact" required>
        <label>Category *</label>
        <select id="category" required>
          <option value="">Select</option>
          <option value="Driver">Driver</option>
          <option value="IT">IT</option>
          <option value="Construction">Construction</option>
          <option value="Hospitality">Hospitality</option>
          <option value="Engineering">Engineering</option>
          <option value="Accountant">Accountant</option>
          <option value="Delivery">Delivery</option>
          <option value="Others">Others</option>
        </select>
        <label>Poster (optional)</label>
        <input type="file" id="poster" accept="image/*">
        <button type="button" onclick="postJob()">Post Job</button>
        <div class="success" id="successMsg">✅ Job Posted Successfully!</div>
      </form>
    </div>
  </div>

  <script>
    // ✅ Supabase Setup
    const SUPABASE_URL = "https://ehoctsjvtfuesqeonlco.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVob2N0c2p2dGZ1ZXNxZW9ubGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTU2ODcsImV4cCI6MjA3MjU3MTY4N30.kGz2t58YXWTwOB_h40dH0GOBLF12FQxKsZnqQ983Xro";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const feedEl = document.getElementById("feed");
    const modal = document.getElementById("jobModal");
    const successMsg = document.getElementById("successMsg");

    function openModal() { modal.style.display = "flex"; clearForm(); }
    function closeModal() { modal.style.display = "none"; successMsg.style.display = "none"; }
    function clearForm() { document.getElementById("jobForm").reset(); }

    async function loadJobs() {
      feedEl.innerHTML = "Loading jobs...";
      const now = new Date();

      let { data: jobs, error } = await supabase
        .from("jobs")
        .select("*")
        .order("date", { ascending: false });

      if (error) {
        console.error(error);
        feedEl.innerHTML = "<p style='color:red;text-align:center;'>Error loading jobs</p>";
        return;
      }

      jobs = jobs.filter(job => new Date(job.expiry) > now);

      const search = document.getElementById("searchInput").value.toLowerCase();
      const category = document.getElementById("categoryFilter").value;

      const filtered = jobs.filter(j => {
        const matchSearch = !search || j.position.toLowerCase().includes(search) || j.description.toLowerCase().includes(search) || j.company.toLowerCase().includes(search);
        const matchCat = !category || j.category === category;
        return matchSearch && matchCat;
      });

      if (filtered.length === 0) {
        feedEl.innerHTML = "<div class='card'>No jobs found</div>";
        return;
      }

      feedEl.innerHTML = "";
      filtered.forEach(job => {
        const daysAgo = Math.floor((now - new Date(job.date)) / (1000*60*60*24));
        const timeText = daysAgo === 0 ? "Today" : daysAgo === 1 ? "1 day ago" : `${daysAgo} days ago`;

        const card = document.createElement("div");
        card.className = "card post";
        card.innerHTML = `
          <h3>${job.position} - ${job.company}</h3>
          <small>Posted ${timeText}</small>
          <p><strong>Job:</strong> ${job.description}</p>
          ${job.salary ? `<p><strong>Salary:</strong> ${job.salary}</p>` : ""}
          <p><strong>Category:</strong> ${job.category}</p>
          ${job.poster ? `<img src="${job.poster}" alt="Job Poster">` : ""}
          <div class="share-btns">
            <button onclick="shareWhatsApp('${job.id}')">WhatsApp</button>
            <button onclick="shareFacebook('${job.id}')">Facebook</button>
            <button onclick="copyLink('${job.id}')">Copy Link</button>
          </div>
        `;
        feedEl.appendChild(card);
      });
    }

    async function postJob() {
      const pos = document.getElementById("position").value.trim();
      const desc = document.getElementById("description").value.trim();
      const sal = document.getElementById("salary").value.trim();
      const comp = document.getElementById("company").value.trim();
      const cont = document.getElementById("contact").value.trim();
      const cat = document.getElementById("category").value;
      const fileInput = document.getElementById("poster");

      let posterData = "";
      if (fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = async e => {
          posterData = e.target.result;
          await saveJob(pos, desc, sal, comp, cont, cat, posterData);
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        await saveJob(pos, desc, sal, comp, cont, cat, "");
      }
    }

    async function saveJob(pos, desc, sal, comp, cont, cat, poster) {
      const expiry = new Date(Date.now() + 14*24*60*60*1000).toISOString();
      const { error } = await supabase
        .from("jobs")
        .insert([{ position: pos, description: desc, salary: sal, company: comp, contact: cont, category: cat, poster: poster, date: new Date().toISOString(), expiry: expiry }]);

      if (error) {
        alert("Error posting job");
        console.error(error);
        return;
      }

      successMsg.style.display = "block";
      setTimeout(() => { closeModal(); loadJobs(); }, 1500);
    }

    // Share functions
    async function getJobById(id) {
      let { data, error } = await supabase.from("jobs").select("*").eq("id", id).single();
      return data;
    }
    async function shareWhatsApp(id) {
      const job = await getJobById(id); if (!job) return;
      const text = `🔹 ${job.position} - ${job.company}
📋 ${job.description}
🌐 Find more jobs at: https://farisconnects.github.io/halajobs-qa/`;
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
    }
    async function shareFacebook(id) {
      const job = await getJobById(id); if (!job) return;
      const text = `${job.position} - ${job.company}
📋 ${job.description}`;
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent("https://farisconnects.github.io/halajobs-qa/")}&quote=${encodeURIComponent(text)}`);
    }
    async function copyLink(id) {
      const job = await getJobById(id); if (!job) return;
      const text = `🔹 ${job.position} - ${job.company}
📋 ${job.description}
🌐 Find more jobs at: https://farisconnects.github.io/halajobs-qa/`;
      navigator.clipboard.writeText(text).then(()=>alert("✅ Copied"));
    }

    window.onclick = e => { if (e.target == modal) closeModal(); }
    document.getElementById("searchInput").addEventListener("input", loadJobs);
    document.getElementById("categoryFilter").addEventListener("change", loadJobs);

    loadJobs();
  </script>
</body>
</html>
